<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI RAG 백엔드 아키텍처 탐색기</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Architecture description derived from docs/rag_architecture.md -->
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(56, 97, 219, 0.35), transparent 55%), radial-gradient(circle at 80% 10%, rgba(17, 135, 189, 0.3), transparent 45%), linear-gradient(180deg, #030712 0%, #020410 80%);
            overflow-x: hidden;
            color: #e5e7f0;
            min-height: 100vh;
            position: relative;
        }
        body .text-gray-900,
        body .text-slate-900 { color: #f9fafb !important; }
        body .text-gray-800,
        body .text-slate-800 { color: #e2e8f0 !important; }
        body .text-gray-700,
        body .text-slate-700 { color: #dbeafe !important; }
        body .text-gray-600,
        body .text-slate-600 { color: #cbd5f5 !important; }
        body .text-gray-500,
        body .text-slate-500 { color: #bcd2ff !important; }
        .component {
            position: relative;
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            color: #0f172a;
            background: linear-gradient(165deg, rgba(255, 255, 255, 0.72), rgba(236, 240, 255, 0.22));
            border: 1px solid rgba(255, 255, 255, 0.55);
            box-shadow: 0 18px 32px rgba(3, 7, 18, 0.22);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
        }
        .component::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.05) 45%, transparent 70%);
            opacity: 0.65;
            pointer-events: none;
        }
        .component > * {
            position: relative;
            z-index: 1;
        }
        .component.selected {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.7);
            transform: scale(1.03);
        }
        .component.highlight {
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }
        .glass-panel {
            position: relative;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: inherit;
            box-shadow: 0 32px 70px rgba(3, 7, 18, 0.55);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            overflow: hidden;
        }
        .glass-panel::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.01) 45%, transparent 70%);
            opacity: 0.4;
        }
        .glass-panel::after {
            content: "";
            position: absolute;
            inset-inline: 0;
            top: 0;
            height: 1px;
            border-radius: inherit;
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.72), rgba(255, 255, 255, 0));
            pointer-events: none;
            opacity: 0.85;
        }
        .glass-panel > * { position: relative; z-index: 1; }
        .config { background: linear-gradient(155deg, rgba(220, 239, 251, 0.55), rgba(220, 239, 251, 0.1)); border-color: rgba(166, 205, 228, 0.45); }
        .embed { background: linear-gradient(155deg, rgba(255, 224, 178, 0.52), rgba(255, 224, 178, 0.08)); border-color: rgba(230, 185, 128, 0.44); }
        .logging { background: linear-gradient(155deg, rgba(200, 230, 201, 0.5), rgba(200, 230, 201, 0.08)); border-color: rgba(151, 194, 153, 0.4); }
        .sources { background: linear-gradient(155deg, rgba(255, 253, 231, 0.5), rgba(255, 253, 231, 0.08)); border-color: rgba(230, 228, 179, 0.38); }
        .parser { background: linear-gradient(155deg, rgba(255, 243, 224, 0.52), rgba(255, 243, 224, 0.08)); border-color: rgba(230, 211, 176, 0.42); }
        .ingestion { background: linear-gradient(155deg, rgba(243, 229, 245, 0.52), rgba(243, 229, 245, 0.1)); border-color: rgba(211, 189, 224, 0.42); }
        .vector-store { background: linear-gradient(155deg, rgba(225, 245, 254, 0.52), rgba(225, 245, 254, 0.1)); border-color: rgba(176, 217, 230, 0.42); }
        .orchestrator { background: linear-gradient(155deg, rgba(224, 247, 250, 0.52), rgba(224, 247, 250, 0.1)); border-color: rgba(176, 223, 230, 0.42); }
        .api { background: linear-gradient(155deg, rgba(230, 238, 156, 0.52), rgba(230, 238, 156, 0.1)); border-color: rgba(194, 204, 112, 0.42); }
        .llm { background: linear-gradient(155deg, rgba(209, 213, 255, 0.52), rgba(209, 213, 255, 0.1)); border-color: rgba(165, 180, 252, 0.45); }
        #component-nav .nav-item {
            display: block;
            color: #dbeafe;
            background: rgba(15, 23, 42, 0.32);
            border: 1px solid rgba(99, 102, 241, 0.18);
            backdrop-filter: blur(12px);
            transition: all 0.25s ease;
        }
        #component-nav .nav-item:hover {
            background: rgba(59, 130, 246, 0.28);
            color: #ffffff;
            border-color: rgba(59, 130, 246, 0.55);
            transform: translateY(-1px);
        }
        #component-nav .nav-item.nav-active {
            background: rgba(59, 130, 246, 0.45);
            color: #ffffff;
            border-color: rgba(129, 140, 248, 0.8);
            box-shadow: 0 10px 22px rgba(37, 99, 235, 0.35);
            transform: translateY(-2px);
        }
        @media (max-width: 1280px) {
            #info-panel { position: static; top: auto; }
        }
        @media (max-width: 1024px) {
            header h1 { font-size: 2.25rem; }
            header p { font-size: 1.125rem; }
            #simulate-btn { width: 100%; max-width: 22rem; }
        }
        @media (max-width: 768px) {
            header h1 { font-size: 1.875rem; }
            header p { font-size: 1rem; }
            main > * { width: 100%; }
            .component { font-size: 0.85rem; padding: 0.75rem; min-height: 3rem; }
            #info-panel { margin-top: 1.5rem; box-shadow: none; }
        }
        @media (max-width: 480px) {
            .component { font-size: 0.8rem; padding: 0.6rem; min-height: 2.5rem; }
            #simulate-btn { padding-left: 1.5rem; padding-right: 1.5rem; }
        }
    </style>
</head>
<body class="dark-sky text-gray-100">
    <canvas id="bg-stars" class="fixed inset-0 w-full h-full pointer-events-none"></canvas>
    <div class="relative z-10">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="text-center mb-8">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">FastAPI 기반 RAG 백엔드 아키텍처 탐색기</h1>
                <p class="mt-2 text-lg text-gray-600">FastAPI로 구현된 Retrieval-Augmented Generation 백엔드는 설정·로깅, 코퍼스 ingestion, 임베딩, 오케스트레이션, API 계층이 촘촘하게 연결되어 동작합니다.</p>
                <p class="mt-1 text-base text-gray-500">이 페이지는 <code>docs/rag_architecture.md</code>의 설명을 토대로 구성되었으며, 각 박스를 클릭하면 모듈별 책임과 운영 포인트를 확인할 수 있습니다.</p>
            </header>
            <section class="glass-panel p-6 rounded-2xl shadow-lg mb-10">
                <h2 class="text-2xl font-bold mb-4">아키텍처 개요</h2>
                <ol class="list-decimal list-inside space-y-4 text-base leading-relaxed">
                    <li>
                        <p class="font-semibold">설정 · 로깅 공통 계층 (settings.py, embed_config.py, logging_config.py)</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm sm:text-base">
                            <li>환경 변수와 <code>.env</code>를 통해 모델, Chroma 호스트, 사전 경로 등 런타임 상수를 선언적으로 관리합니다.</li>
                            <li><code>embed_config.py</code>는 오프라인 모드 전환과 모델 존재 여부를 검사하고 캐시 경로를 조정합니다.</li>
                            <li><code>logging_config.py</code>의 JSON 포맷 로그가 CLI와 FastAPI 엔드포인트에서 동일하게 사용됩니다.</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-semibold">코퍼스 확보 및 정제 (wikipedia_ingest.py, mdn_ingest.py, korean_dictionary_ingest.py)</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm sm:text-base">
                            <li><code>ensure_*_corpus()</code> 호출로 위키백과, MDN, 국어사전 데이터를 내려받고 최신성을 검증합니다.</li>
                            <li>다운로드된 자료는 프로젝트 구조에 맞춰 저장되고 중복 여부가 점검됩니다.</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-semibold">텍스트 · 코드 청크 구성 (chunking.py, parse_code.py)</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm sm:text-base">
                            <li>tree-sitter 기반 파서가 클래스·함수 시그니처 등 메타데이터를 보존한 채 코드 블록을 추출합니다.</li>
                            <li>청크화된 텍스트와 메타데이터는 인용, 하이라이트, 중복 제거에 활용됩니다.</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-semibold">임베딩 생성과 벡터 저장 (ingest.py, SentenceTransformer, Chroma)</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm sm:text-base">
                            <li>CLI 진입점인 <code>ingest.py</code>가 청크 로딩, 임베딩 생성, Chroma 업서트를 순차적으로 수행합니다.</li>
                            <li>SentenceTransformer 기반 KorBERT 임베딩이 오프라인 모드에서도 일관되게 생성됩니다.</li>
                        </ul>
                    </li>
                    <li>
                        <p class="font-semibold">런타임 오케스트레이션과 API 계층 (rag_orchestrator.py, api.py)</p>
                        <ul class="list-disc list-inside ml-4 space-y-1 text-sm sm:text-base">
                            <li><code>rag_orchestrator.py</code>는 LlamaIndex를 통해 Chroma에서 문맥을 Retrieval 하고 LLM 응답을 조합합니다.</li>
                            <li><code>api.py</code>는 <code>/rag/query</code>, <code>/rag/ingest</code>, <code>/rag/embed-config</code> 엔드포인트를 제공하며 작업 실행 상태와 로그 스트리밍을 관리합니다.</li>
                        </ul>
                    </li>
                </ol>
            </section>
            <div class="flex justify-center mb-8">
                <button id="simulate-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                    파이프라인 시뮬레이션 시작
                </button>
            </div>
            <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <aside class="lg:col-span-2 glass-panel bg-white p-4 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2 text-gray-900">구성 요소</h2>
                    <nav id="component-nav" class="space-y-2">
                    </nav>
                </aside>
                <div class="lg:col-span-7 glass-panel diagram-container bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex flex-col space-y-8 w-full" id="diagram-root">
                        <div class="glass-panel w-full max-w-4xl mx-auto p-6 rounded-2xl">
                            <h3 class="text-center font-semibold text-gray-500 mb-4 text-sm sm:text-base">Config & Utilities</h3>
                            <div class="flex flex-col sm:flex-row justify-around items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                <div id="A" data-id="A" class="component config p-3 rounded-lg text-center w-full sm:w-48">settings.py</div>
                                <div id="B" data-id="B" class="component embed p-3 rounded-lg text-center w-full sm:w-48">embed_config.py</div>
                                <div id="C" data-id="C" class="component logging p-3 rounded-lg text-center w-full sm:w-48">logging_config.py</div>
                            </div>
                        </div>
                        <div class="glass-panel w-full max-w-4xl mx-auto p-6 rounded-2xl">
                            <h3 class="text-center font-semibold text-gray-500 mb-4 text-sm sm:text-base">Ingestion Pipeline</h3>
                            <div class="flex flex-col items-center space-y-4">
                                <div id="D" data-id="D" class="component ingestion p-3 rounded-lg text-center w-full sm:w-56">ingest.py</div>
                                <div class="w-full max-w-3xl mx-auto glass-panel p-4 rounded-2xl">
                                    <h4 class="text-center font-semibold text-gray-400 mb-2 text-xs sm:text-sm">Preparation Stages</h4>
                                    <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 sm:space-x-4">
                                        <div id="F" data-id="F" class="component sources p-3 rounded-lg text-center w-full sm:w-48">ensure_*_corpus 스크립트</div>
                                        <div id="E" data-id="E" class="component parser p-3 rounded-lg text-center w-full sm:w-48">chunking.py · parse_code.py</div>
                                        <div id="G" data-id="G" class="component vector-store p-3 rounded-lg text-center w-full sm:w-48">SentenceTransformer + Chroma</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="glass-panel w-full max-w-4xl mx-auto p-6 rounded-2xl">
                            <h3 class="text-center font-semibold text-gray-500 mb-3 text-sm sm:text-base">Runtime & API Layer</h3>
                            <div class="flex flex-col items-center space-y-4">
                                <div id="H" data-id="H" class="component orchestrator p-3 rounded-lg text-center w-full sm:w-56">rag_orchestrator.py</div>
                                <div class="flex flex-col sm:flex-row justify-around items-center space-y-4 sm:space-y-0 sm:space-x-4 w-full">
                                    <div id="I" data-id="I" class="component api p-3 rounded-lg text-center w-full sm:w-56">api.py · /rag/* endpoints</div>
                                    <div id="J" data-id="J" class="component llm p-3 rounded-lg text-center w-full sm:w-56">Ollama LLMs (Llama 3.3 · Qwen3-coder)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="lg:col-span-3">
                    <div id="info-panel" class="sticky top-8 glass-panel p-6 rounded-xl shadow-lg">
                        <h2 id="info-title" class="text-2xl font-bold mb-3 text-gray-900">아키텍처 개요</h2>
                        <div id="info-content" class="text-gray-700 space-y-4">
                            <p><code>docs/rag_architecture.md</code>는 FastAPI 기반 RAG 백엔드를 설정 계층, 코퍼스 ingestion, 임베딩, 런타임 서비스의 네 축으로 설명합니다. 각 모듈은 공통 설정을 공유하면서도 명확한 책임 경계를 유지합니다.</p>
                            <p>왼쪽 내비게이션 또는 중앙 다이어그램의 박스를 눌러 세부 책임, 주요 의존성, 운영상의 주의점을 살펴보세요. 시뮬레이션 버튼을 누르면 대표적인 데이터 흐름을 따라가며 확인할 수 있습니다.</p>
                            <div class="mt-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">운영 하이라이트</h4>
                                <ul class="list-disc list-inside text-sm text-blue-700 space-y-1">
                                    <li><code>embed_config.ensure_offline_mode()</code>로 외부 네트워크 없이도 모델 구성이 유지됩니다.</li>
                                    <li><code>_start_ingest_job()</code>이 단일 ingest 프로세스를 보장하고 재실행 여부를 제어합니다.</li>
                                    <li>코드 청크 메타데이터는 <code>rag_orchestrator.py</code>의 인용·하이라이트 품질을 좌우합니다.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            <section class="mt-12 mb-8">
                <div class="glass-panel p-6 sm:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl sm:text-3xl font-bold text-center mb-2 text-gray-900">운영 플로우</h2>
                    <p class="text-center text-gray-600 mb-6">RAG 백엔드가 질의를 처리하기까지의 단계별 책임 정리</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="glass-panel p-5 rounded-lg config border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-md">1</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">환경 변수 로딩</h3>
                            </div>
                            <p class="text-sm text-gray-600"><code>settings.py</code>가 OLLAMA, Chroma, 사전 경로 등 공통 런타임 상수를 노출합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg embed border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-bold text-lg shadow-md">2</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">임베딩 구성 점검</h3>
                            </div>
                            <p class="text-sm text-gray-600"><code>embed_config.py</code>와 <code>logging_config.py</code>가 오프라인 모드와 공통 로깅 포맷을 초기화합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg sources border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 flex items-center justify-center text-white font-bold text-lg shadow-md">3</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">코퍼스 확보</h3>
                            </div>
                            <p class="text-sm text-gray-600"><code>ensure_wikipedia_corpus()</code> 등 스크립트가 데이터 최신성과 경로를 보장합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg parser border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-400 to-amber-600 flex items-center justify-center text-white font-bold text-lg shadow-md">4</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">청크 & 코드 파싱</h3>
                            </div>
                            <p class="text-sm text-gray-600"><code>chunking.py</code>와 <code>parse_code.py</code>가 청크 메타데이터와 코드 시그니처를 구성합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg ingestion border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-purple-600 flex items-center justify-center text-white font-bold text-lg shadow-md">5</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">ingest.py 실행</h3>
                            </div>
                            <p class="text-sm text-gray-600">CLI 진입점이 청크 로딩, 임베딩 생성, 로그 스트리밍을 순차적으로 처리합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg vector-store border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-cyan-400 to-cyan-600 flex items-center justify-center text-white font-bold text-lg shadow-md">6</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">Chroma 업서트</h3>
                            </div>
                            <p class="text-sm text-gray-600">기존 벡터를 삭제·갱신하고 새로운 임베딩을 upsert하여 검색 품질을 유지합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg orchestrator border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center text-white font-bold text-lg shadow-md">7</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">RAG 오케스트레이션</h3>
                            </div>
                            <p class="text-sm text-gray-600"><code>rag_orchestrator.ensure_ready()</code>가 모델 캐시와 인덱스를 준비합니다.</p>
                        </div>
                        <div class="glass-panel p-5 rounded-lg api border-2 hover:scale-105 transition-transform duration-300">
                            <div class="flex items-center mb-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-lime-400 to-lime-600 flex items-center justify-center text-white font-bold text-lg shadow-md">8</div>
                                <h3 class="ml-3 font-bold text-lg text-gray-900">FastAPI 응답</h3>
                            </div>
                            <p class="text-sm text-gray-600"><code>api.py</code>가 <code>/rag/query</code>와 <code>/rag/ingest</code> 요청을 처리하고 결과를 반환합니다.</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>
    <script src="bg-stars.js" defer></script>
    <script>
        const componentData = {
            'A': {
                title: 'settings.py',
                role: '환경 변수 기반 설정 허브',
                tech: 'Python, os.environ',
                description: '프로젝트 전역에서 사용하는 OLLAMA, CHROMA, 사전 경로, ingest 주기 등을 선언적으로 관리합니다. 모든 모듈이 동일한 설정 객체를 가져와 일관된 런타임 구성을 유지합니다.'
            },
            'B': {
                title: 'embed_config.py',
                role: '임베딩 모델 구성 관리자',
                tech: 'Python, Hugging Face, dotenv',
                description: '오프라인 모드 전환, 모델 존재 여부 검증, 캐시 경로 재설정, .env 동기화를 담당합니다. FastAPI와 CLI 모두에서 임베딩 구성이 즉시 반영되도록 보조합니다.'
            },
            'C': {
                title: 'logging_config.py',
                role: '공통 로깅 포맷 제공',
                tech: 'logging, logging.config',
                description: 'JSON 기반 로깅 설정과 RequestId 필터를 정의하여 ingest 서브프로세스와 FastAPI 엔드포인트 로그를 동일 포맷으로 수집합니다.'
            },
            'F': {
                title: 'ensure_*_corpus 스크립트',
                role: '코퍼스 데이터 확보',
                tech: 'httpx, mwparserfromhell, pathlib',
                description: 'wikipedia_ingest.py, mdn_ingest.py, korean_dictionary_ingest.py가 원천 데이터를 내려받고 유효성을 검사합니다. 데이터가 최신 상태인지 확인한 뒤 ingestion 파이프라인이 사용할 디렉터리에 적재합니다.'
            },
            'E': {
                title: 'chunking.py · parse_code.py',
                role: '텍스트·코드 청크 전처리',
                tech: 'tree-sitter, Python',
                description: '문서와 코드 파일을 청크 단위로 분할하고 클래스/함수 시그니처, 코드 여부 등의 메타데이터를 부착합니다. 생성된 메타데이터는 인용과 검색 정확도를 높이는 데 활용됩니다.'
            },
            'D': {
                title: 'ingest.py',
                role: 'Ingestion 오케스트레이터',
                tech: 'SentenceTransformer, chromadb, Python CLI',
                description: 'CLI 진입점으로 실행되어 코퍼스 로딩, 임베딩 생성, 벡터 스토어 upsert를 순차적으로 수행합니다. 표준 출력 로그를 FastAPI가 스트리밍할 수 있도록 설계되었습니다.'
            },
            'G': {
                title: 'SentenceTransformer + Chroma',
                role: '임베딩 생성 및 벡터 저장',
                tech: 'SentenceTransformer, ChromaDB',
                description: 'KorBERT 기반 SentenceTransformer가 벡터를 생성하고 ChromaDB가 이를 저장·검색합니다. 기존 컬렉션을 정리한 뒤 새로운 임베딩을 upsert하여 최신 상태를 유지합니다.'
            },
            'H': {
                title: 'rag_orchestrator.py',
                role: 'LlamaIndex 기반 RAG 오케스트레이터',
                tech: 'llama_index, httpx',
                description: 'ensure_ready()로 모델과 인덱스를 준비하고, query 시 Chroma에서 문맥을 조회한 뒤 LLM 응답을 구성합니다. 모델 목록 조회 및 리로드도 담당합니다.'
            },
            'I': {
                title: 'api.py',
                role: 'FastAPI 서비스 계층',
                tech: 'FastAPI, Python',
                description: 'FastAPI 애플리케이션을 구성해 /rag/query, /rag/ingest, /rag/embed-config 엔드포인트를 제공합니다. ingest 실행을 단일 프로세스로 제한하고 표준 출력 로그를 스트리밍합니다.'
            },
            'J': {
                title: 'Ollama LLMs (Llama 3.3 · Qwen3-coder)',
                role: 'LLM 실행 환경',
                tech: 'Ollama, LlamaIndex',
                description: 'rag_orchestrator.py가 Retrieval한 문맥을 기반으로 Llama 3.3 및 Qwen3-coder 모델에 프롬프트를 전달합니다. 일반 질의와 코드 중심 질의를 각 모델로 라우팅합니다.'
            }
        };

        const flowSequence = ['A', 'B', 'C', 'F', 'E', 'D', 'G', 'H', 'I', 'J'];

        document.addEventListener('DOMContentLoaded', () => {
            const nav = document.getElementById('component-nav');
            const components = document.querySelectorAll('.component');
            const infoTitle = document.getElementById('info-title');
            const infoContent = document.getElementById('info-content');
            const simulateBtn = document.getElementById('simulate-btn');

            Object.keys(componentData).forEach(id => {
                const data = componentData[id];
                const navItem = document.createElement('a');
                navItem.href = '#';
                navItem.className = 'nav-item px-3 py-2 rounded-lg transition-all duration-200 text-sm font-medium';
                navItem.textContent = data.title;
                navItem.dataset.id = id;
                nav.appendChild(navItem);
            });

            const updateInfoPanel = (id) => {
                const data = componentData[id];
                if (!data) return;
                infoTitle.textContent = data.title;
                infoContent.innerHTML = `
                    <p><strong class="font-semibold text-gray-800">역할:</strong> ${data.role}</p>
                    <p><strong class="font-semibold text-gray-800">주요 기술:</strong> ${data.tech}</p>
                    <p class="mt-4 pt-4 border-t">${data.description}</p>
                `;
                components.forEach(comp => {
                    comp.classList.toggle('selected', comp.dataset.id === id);
                });
                nav.querySelectorAll('.nav-item').forEach(item => {
                    const isActive = item.dataset.id === id;
                    item.classList.toggle('nav-active', isActive);
                    if (isActive) item.setAttribute('aria-current', 'true');
                    else item.removeAttribute('aria-current');
                });
            };

            const selectComponent = (id) => {
                updateInfoPanel(id);
                document.getElementById('info-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            document.getElementById('diagram-root').addEventListener('click', (e) => {
                const component = e.target.closest('.component');
                if (component && component.dataset.id) {
                    selectComponent(component.dataset.id);
                }
            });

            nav.addEventListener('click', (e) => {
                e.preventDefault();
                const navItem = e.target.closest('a');
                if (navItem && navItem.dataset.id) {
                    selectComponent(navItem.dataset.id);
                    navItem.blur();
                }
            });

            let isSimulating = false;
            let timeoutId;
            simulateBtn.addEventListener('click', () => {
                if (isSimulating) {
                    clearTimeout(timeoutId);
                    isSimulating = false;
                    simulateBtn.textContent = '파이프라인 시뮬레이션 시작';
                    simulateBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    simulateBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    components.forEach(c => c.classList.remove('highlight'));
                    return;
                }
                isSimulating = true;
                simulateBtn.textContent = '시뮬레이션 중지';
                simulateBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                simulateBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                let step = 0;
                const runStep = () => {
                    components.forEach(c => c.classList.remove('highlight'));
                    if (step >= flowSequence.length) {
                        isSimulating = false;
                        simulateBtn.click();
                        return;
                    }
                    const currentId = flowSequence[step];
                    const currentElement = document.getElementById(currentId);
                    if (currentElement) {
                        currentElement.classList.add('highlight');
                        updateInfoPanel(currentId);
                    }
                    step++;
                    timeoutId = setTimeout(runStep, 1500);
                };
                runStep();
            });

            updateInfoPanel('A');
        });
    </script>
</body>
</html>
