<!doctype html>
<html lang="ko" class="scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG 플랫폼 홈</title>
  <meta name="description" content="FastAPI + Tomcat 기반 RAG 시스템 대시보드" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='black'/%3E%3Cpath d='M50 18 L78 82 H22 Z' fill='white'/%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>window.tailwind=window.tailwind||{};window.tailwind.config={theme:{extend:{boxShadow:{glow:'0 0 0 1px rgb(255 255 255 / 0.12), 0 8px 30px rgb(0 0 0 / 0.30)'},},}};</script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: true, theme: 'dark' });</script>
  <style>
    /* subtle dot grid background */
    body::before{content:"";position:fixed;inset:0;background:radial-gradient(circle at 1px 1px,rgba(255,255,255,.08) 1px,transparent 1px);background-size:24px 24px;pointer-events:none;}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950 text-slate-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-slate-900/60 border-b border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="size-8 rounded-lg bg-white/10 grid place-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="size-5"><path d="M12 3l8 4-8 4-8-4 8-4Z"/><path d="M4 11l8 4 8-4"/><path d="M4 17l8 4 8-4"/></svg>
      </div>
      <h1 class="text-lg font-semibold tracking-tight">RAG 플랫폼</h1>
      <span class="ml-auto"></span>
      <div class="hidden sm:flex items-center gap-2">
        <label for="apiBase" class="text-xs text-slate-300">API BASE</label>
        <input id="apiBase" class="px-2 py-1 rounded-md bg-white/10 border border-white/10 text-sm w-56" placeholder="예: https://rag.example.com" />
        <button id="saveBase" class="px-3 py-1.5 rounded-md bg-indigo-500 hover:bg-indigo-600 text-sm">저장</button>
        <button id="toggleTheme" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20 text-sm">테마</button>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="relative">
    <div class="max-w-7xl mx-auto px-4 py-10">
      <div class="grid md:grid-cols-2 gap-6 items-center">
        <div>
          <h2 class="text-3xl md:text-4xl font-bold tracking-tight">
            Retrieval-Augmented Generation 운영 홈
          </h2>
          <p class="mt-3 text-slate-300">FastAPI 백엔드와 Tomcat UI, Chroma, Redis, Ollama로 구성된 RAG 스택을 제어하고 상태를 확인합니다.</p>
          <div class="mt-6 flex flex-wrap gap-3">
            <a href="#quick" class="px-4 py-2 rounded-xl bg-indigo-500 hover:bg-indigo-600 shadow-glow">빠른 실행</a>
            <a href="#stack" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">서비스 스택</a>
            <a href="#diagram" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20">시퀀스</a>
          </div>
        </div>
        <div class="relative">
          <div class="rounded-2xl border border-white/10 bg-white/5 p-4 shadow-glow">
            <div class="flex items-center justify-between">
              <h3 class="font-medium">시스템 상태</h3>
              <button id="refreshStatus" class="text-sm px-3 py-1 rounded-md bg-white/10 hover:bg-white/20">새로고침</button>
            </div>
            <div id="statusBox" class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-3 text-sm"></div>
            <pre id="statusRaw" class="mt-3 hidden p-3 bg-black/40 rounded-lg overflow-auto text-xs"></pre>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Actions -->
  <section id="quick" class="py-6">
    <div class="max-w-7xl mx-auto px-4 grid lg:grid-cols-3 gap-6">
      <!-- Query -->
      <div class="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-glow">
        <h3 class="font-semibold">질의 실행</h3>
        <p class="text-sm text-slate-300">컨텍스트 검색 + LLM 추론 결과를 확인합니다.</p>
        <label class="block mt-3 text-sm">질문</label>
        <textarea id="qInput" class="w-full mt-1 rounded-lg bg-black/40 border border-white/10 p-3" rows="3" placeholder="예) MDN 인제스트 후 색인 통계는?" ></textarea>
        <div class="mt-2 flex items-center gap-3">
          <label class="text-xs text-slate-300">top_k</label>
          <input id="qTopK" type="range" min="2" max="10" value="5" class="w-32">
          <span id="qTopKVal" class="text-xs">5</span>
          <span class="ml-auto"></span>
          <button id="runQuery" class="px-3 py-1.5 rounded-md bg-indigo-500 hover:bg-indigo-600">실행</button>
        </div>
        <div id="qResult" class="mt-4 hidden">
          <div class="text-xs uppercase tracking-wide text-slate-400">응답</div>
          <div id="qAnswer" class="mt-1 whitespace-pre-wrap"></div>
          <div class="mt-3 text-xs uppercase tracking-wide text-slate-400">출처</div>
          <ul id="qSources" class="mt-1 space-y-1 text-sm"></ul>
          <details class="mt-3">
            <summary class="cursor-pointer text-sm text-slate-300">원시 응답 보기</summary>
            <pre id="qRaw" class="mt-2 p-3 bg-black/40 rounded-lg overflow-auto text-xs"></pre>
          </details>
        </div>
      </div>

      <!-- Ingest -->
      <div class="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-glow">
        <h3 class="font-semibold">인제스트 작업</h3>
        <p class="text-sm text-slate-300">선택한 소스를 백그라운드로 수집·임베딩합니다.</p>
        <div class="mt-3 grid grid-cols-2 gap-x-3 gap-y-2 text-sm">
          <label class="inline-flex items-center gap-2"><input type="checkbox" value="topik_vocab" class="ingestSrc">TOPIK 어휘</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" value="mdn" class="ingestSrc">MDN</label>
          <label class="inline-flex items-center gap-2"><input type="checkbox" value="korean_dictionary" class="ingestSrc">Korean Dictionary</label>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <button id="runIngest" class="px-3 py-1.5 rounded-md bg-indigo-500 hover:bg-indigo-600">인제스트 시작</button>
          <button id="viewLogs" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20">로그 보기</button>
        </div>
        <pre id="ingestOut" class="mt-3 hidden p-3 bg-black/40 rounded-lg overflow-auto text-xs"></pre>
      </div>

      <!-- Embed Config -->
      <div class="rounded-2xl border border-white/10 bg-white/5 p-5 shadow-glow">
        <h3 class="font-semibold">임베딩 설정</h3>
        <p class="text-sm text-slate-300">온라인/오프라인 모드 전환과 모델 경로를 제어합니다.</p>
        <div class="mt-3 grid gap-2 text-sm">
          <div>모드: <span id="embedMode" class="px-2 py-0.5 rounded bg-white/10">-</span></div>
          <div>모델: <span id="embedModel" class="px-2 py-0.5 rounded bg-white/10">-</span></div>
        </div>
        <div class="mt-3 flex items-center gap-2">
          <button id="toggleEmbed" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20">모드 토글</button>
          <button id="refreshEmbed" class="px-3 py-1.5 rounded-md bg-white/10 hover:bg-white/20">상태 새로고침</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Stack -->
  <section id="stack" class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <h3 class="text-xl font-semibold">전체 서비스 스택</h3>
      <div class="mt-4 grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5"><div class="text-sm text-slate-400">서비스</div><div class="font-semibold">rag-ui</div><ul class="mt-2 text-sm list-disc list-inside text-slate-300"><li>Tomcat 10 정적 리소스</li><li>frontend/index.html, app.js, styles.css</li><li>포트 8080</li></ul></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5"><div class="text-sm text-slate-400">서비스</div><div class="font-semibold">rag-api</div><ul class="mt-2 text-sm list-disc list-inside text-slate-300"><li>FastAPI 백엔드</li><li>인제스트, 질의, 설정 API</li><li>포트 8000</li></ul></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5"><div class="text-sm text-slate-400">서비스</div><div class="font-semibold">rag-chroma</div><ul class="mt-2 text-sm list-disc list-inside text-slate-300"><li>Chroma 벡터 스토어</li><li>영구 볼륨 /data/chroma</li><li>포트 8001(호스트)/8000(컨테이너)</li></ul></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5"><div class="text-sm text-slate-400">서비스</div><div class="font-semibold">rag-redis</div><ul class="mt-2 text-sm list-disc list-inside text-slate-300"><li>작업 큐 및 상태 캐시</li><li>포트 6379</li></ul></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5"><div class="text-sm text-slate-400">서비스</div><div class="font-semibold">rag-ollama</div><ul class="mt-2 text-sm list-disc list-inside text-slate-300"><li>LLM 호스팅(Ollama)</li><li>기본 모델 qwen2.5:3b-instruct-q4_K_M</li><li>포트 11434</li></ul></div>
        <div class="rounded-2xl border border-white/10 bg-white/5 p-5"><div class="text-sm text-slate-400">볼륨</div><div class="font-semibold">데이터 보존</div><ul class="mt-2 text-sm list-disc list-inside text-slate-300"><li>./data/chroma → /data/chroma</li><li>./data/raw → /data/raw</li><li>./data/models → /data/models</li><li>./data/ollama → /root/.ollama</li><li>.env → /app/.env</li></ul></div>
      </div>

      <details class="mt-6 rounded-2xl border border-white/10 bg-white/5 p-5">
        <summary class="cursor-pointer font-medium">API 엔드포인트</summary>
        <ul class="mt-3 grid md:grid-cols-2 gap-2 text-sm text-slate-300">
          <li><code>GET /rag/status</code> 시스템 헬스 및 최근 작업</li>
          <li><code>POST /rag/query</code> 질문/답변</li>
          <li><code>POST /rag/ingest</code> 소스 인제스트</li>
          <li><code>GET · PUT /rag/embed-config</code> 임베딩 모드</li>
          <li><code>GET · POST /rag/documents</code> 수동 업로드</li>
        </ul>
      </details>

      <details class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-5">
        <summary class="cursor-pointer font-medium">주요 모듈</summary>
        <ul class="mt-3 space-y-1 text-sm text-slate-300">
          <li><code>app/api.py</code> 라우터</li>
          <li><code>app/rag_orchestrator.py</code> 질의 오케스트레이터</li>
          <li><code>app/ingest.py</code> 인제스트 엔트리포인트</li>
          <li><code>app/chunking.py</code> 청크/파싱</li>
          <li><code>app/embed_config.py</code> 임베딩 모드</li>
        </ul>
      </details>

      <details class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-5">
        <summary class="cursor-pointer font-medium">환경 변수</summary>
        <div class="mt-3 grid md:grid-cols-2 gap-3 text-sm text-slate-300">
          <div>
            <div class="font-semibold text-slate-200">일반</div>
            <ul class="list-disc list-inside">
              <li><code>INGEST_ALLOW_DOWNLOADS</code></li>
              <li><code>KOREAN_DICT_ENABLED</code>, <code>TOPIK_VOCAB_ENABLED</code></li>
              <li><code>KOREAN_DICT_REFRESH_HOURS</code>, <code>TOPIK_VOCAB_REFRESH_HOURS</code></li>
            </ul>
          </div>
          <div>
            <div class="font-semibold text-slate-2 00">임베딩/모델</div>
            <ul class="list-disc list-inside">
              <li><code>EMBED_MODEL</code>, <code>EMBED_MODEL_ALLOW_DOWNLOADS</code>, <code>EMBED_MODEL_LOCAL_PATH</code></li>
              <li><code>RAG_API_BASE_URL</code></li>
              <li><code>OLLAMA_MODEL</code>, <code>OLLAMA_NUM_CTX</code>, <code>SYSTEM_PROMPT</code></li>
            </ul>
          </div>
        </div>
      </details>
    </div>
  </section>

  <!-- Diagram -->
  <section id="diagram" class="py-8">
    <div class="max-w-7xl mx-auto px-4">
      <h3 class="text-xl font-semibold">시퀀스 다이어그램</h3>
      <div class="mt-4 rounded-2xl border border-white/10 bg-white/5 p-5 overflow-auto">
        <pre class="mermaid text-sm">sequenceDiagram
    participant User
    participant UI as Tomcat UI
    participant API as FastAPI (api.py)
    participant Ingest as ingest.py
    participant Chroma
    participant Ollama

    User->>UI: 버튼 클릭 (질의 / 인제스트)
    UI->>API: REST 호출 (fetch)

    Note over API: 요청 종류에 따라 분기

    API->>Ingest: (인제스트) subprocess + Redis status 갱신
    Ingest->>Sources: ensure_*_corpus()\n(Topik/MDN/Korean dict)
    Ingest->>Chroma: upsert embeddings
    Ingest-->>API: 실시간 로그 스트림
    API-->>UI: 작업 ID / 로그

    API->>Chroma: (질의) similarity search
    API->>Ollama: context + prompt
    Ollama-->>API: 답변/메타데이터
    API-->>UI: JSON 응답(답변, 출처, 토큰 사용량)
    UI-->>User: 화면 렌더링</pre>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-white/10">
    <div class="max-w-7xl mx-auto px-4 py-6 text-sm text-slate-400">
      RAG 시스템 운영관리 · 콘솔 · © <span id="year"></span>
    </div>
  </footer>

  <script>
    // Theme
    const html=document.documentElement;const themeBtn=document.getElementById('toggleTheme');function applyTheme(t){if(t==='light'){html.classList.add('bg-white');html.classList.remove('dark');}else{html.classList.add('dark');}}applyTheme(localStorage.getItem('theme')||'dark');themeBtn?.addEventListener('click',()=>{const next=(localStorage.getItem('theme')||'dark')==='dark'?'light':'dark';localStorage.setItem('theme',next);applyTheme(next)});

    // API Base
    const apiInput=document.getElementById('apiBase');const saveBase=document.getElementById('saveBase');const stored=localStorage.getItem('RAG_API_BASE_URL')||'';apiInput.value=stored;saveBase?.addEventListener('click',()=>{localStorage.setItem('RAG_API_BASE_URL',apiInput.value.trim());alert('저장됨');});
    const API=()=>{const base=localStorage.getItem('RAG_API_BASE_URL')||'';return base.replace(/\/$/,'');}

    // Helpers
    function url(p){return `${API()}${p}`}
    async function safeFetch(input, init){try{const res=await fetch(input, init);const data=await res.json();return {ok:res.ok,data};}catch(e){return {ok:false,data:{error:e?.message||String(e)}}}}

    // Status
    const statusBox=document.getElementById('statusBox');const statusRaw=document.getElementById('statusRaw');async function loadStatus(){const r=await safeFetch(url('/rag/status'));statusRaw.textContent=JSON.stringify(r.data,null,2);statusRaw.classList.toggle('hidden',!r.ok);statusBox.innerHTML='';const entries=[['API',r.ok?'ok':'err'],['Chroma',r.data?.chroma||'-'],['Redis',r.data?.redis||'-'],['Ollama',r.data?.ollama||'-'],['Docs',r.data?.documents??'-'],['LastIngest',r.data?.last_ingest||'-']];for(const [k,v] of entries){const good=String(v).toLowerCase().includes('ok')||String(v).toLowerCase()==='true';const chip=`<span class="px-2 py-0.5 rounded ${good?'bg-emerald-500/20 text-emerald-300':'bg-rose-500/20 text-rose-300'}">${v}</span>`;statusBox.insertAdjacentHTML('beforeend',`<div class="rounded-xl bg-black/30 border border-white/10 p-3"><div class="text-xs text-slate-400">${k}</div><div class="mt-1">${chip}</div></div>`)} }
    document.getElementById('refreshStatus').addEventListener('click',loadStatus);loadStatus();

    // Query
    const qTopK=document.getElementById('qTopK');const qTopKVal=document.getElementById('qTopKVal');qTopK.addEventListener('input',()=>qTopKVal.textContent=qTopK.value);
    document.getElementById('runQuery').addEventListener('click',async()=>{const q=document.getElementById('qInput').value.trim();if(!q)return;const body={question:q, options:{top_k:Number(qTopK.value)}};const r=await safeFetch(url('/rag/query'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});document.getElementById('qResult').classList.remove('hidden');document.getElementById('qRaw').textContent=JSON.stringify(r.data,null,2);document.getElementById('qAnswer').textContent=r.data?.answer||'(no answer)';const srcUl=document.getElementById('qSources');srcUl.innerHTML='';(r.data?.sources||[]).forEach(s=>{const li=document.createElement('li');li.innerHTML=`<a class="underline" href="${s.url||'#'}" target="_blank" rel="noreferrer">${s.title||s.id||'source'}</a> <span class="text-xs text-slate-400">score: ${s.score??'-'}</span>`;srcUl.appendChild(li);});});

    // Ingest
    document.getElementById('runIngest').addEventListener('click',async()=>{const src=[...document.querySelectorAll('.ingestSrc:checked')].map(x=>x.value);if(src.length===0){alert('소스를 선택하세요');return;}const r=await safeFetch(url('/rag/ingest'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sources:src})});const box=document.getElementById('ingestOut');box.classList.remove('hidden');box.textContent=JSON.stringify(r.data,null,2);});
    document.getElementById('viewLogs').addEventListener('click',()=>{document.getElementById('ingestOut').classList.toggle('hidden');});

    // Embed config
    const modeLabel=document.getElementById('embedMode');const modelLabel=document.getElementById('embedModel');async function loadEmbed(){const r=await safeFetch(url('/rag/embed-config'));modeLabel.textContent=r.data?.mode||'-';modelLabel.textContent=r.data?.model||r.data?.EMBED_MODEL||'-';}
    async function toggleEmbed(){const current=modeLabel.textContent.toLowerCase();const next=current==='online'?'offline':'online';const r=await safeFetch(url('/rag/embed-config'),{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({mode:next})});await loadEmbed();}
    document.getElementById('toggleEmbed').addEventListener('click',toggleEmbed);document.getElementById('refreshEmbed').addEventListener('click',loadEmbed);loadEmbed();

    // Footer year
    document.getElementById('year').textContent=new Date().getFullYear();
  </script>
</body>
</html>
